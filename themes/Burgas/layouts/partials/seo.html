{{- /* =========
   SEO partial
   Reads: title, description, images[], thumbnail, feature_image, date/lastmod
   Optional: .Params.seo.{type,twitterCard,noindex}
   Movie JSON-LD uses: film_title, year, minutes, Director/ director, Actors, Screenwriter, Genre
   ========= */ -}}

   {{- $site := site -}}
   {{- $p := . -}}
   
{{- /* Title */ -}}
{{- $title := cond .IsHome site.Title (printf "%s | %s" (or .Title .File.BaseFileName) site.Title) -}}

{{- with .Params.film_title -}}
  {{- $yearPart := "" -}}
  {{- with $.Params.year }}{{ $yearPart = printf " (%v)" . }}{{ end -}}
  {{- $title = printf "%s%s | %s" . $yearPart site.Title -}}
{{- end -}}

   
   {{- /* Description */ -}}
   {{- $desc := or $p.Params.description $p.Summary $site.Params.description -}}
   {{- $desc = $desc | plainify | truncate 160 -}}
   
   {{- /* Canonical */ -}}
   {{- $canonical := $p.Permalink -}}
   
   {{- /* Type, noindex, twitter card */ -}}
   {{- $seo := $p.Params.seo -}}
   {{- $type := cond $p.IsHome "website" "article" -}}
   {{- with $seo }}{{ with .type }}{{ $type = . }}{{ end }}{{ end -}}
   {{- $noindex := false -}}
   {{- with $seo }}{{ with .noindex }}{{ $noindex = . }}{{ end }}{{ end -}}
   {{- $twitterCard := "summary_large_image" -}}
   {{- with $seo }}{{ with .twitterCard }}{{ $twitterCard = . }}{{ end }}{{ end -}}
   
   {{- /* Images: prefer .Params.images[], else feature_image, thumbnail, else site default */ -}}
   {{- $imgs := slice -}}
   {{- with $p.Params.images }}{{ $imgs = . }}{{ end -}}
   {{- if and (eq (len $imgs) 0) $p.Params.feature_image }}{{ $imgs = $imgs | append $p.Params.feature_image }}{{ end -}}
   {{- if and (eq (len $imgs) 0) $p.Params.thumbnail     }}{{ $imgs = $imgs | append $p.Params.thumbnail }}{{ end -}}
   {{- if and (eq (len $imgs) 0) $site.Params.seo.defaultImage }}{{ $imgs = $imgs | append $site.Params.seo.defaultImage }}{{ end -}}
   
   {{- /* make absolute */ -}}
   {{- $absImgs := slice -}}
   {{- range $imgs }}{{ $absImgs = $absImgs | append (absURL .) }}{{ end -}}
   {{- $firstImg := cond (gt (len $absImgs) 0) (index $absImgs 0) "" -}}
   
   {{- /* Dates */ -}}
   {{- $published := $p.Date | time -}}
   {{- $modified  := or $p.Lastmod $p.Date | time -}}
   
   {{- /* Locale / Twitter site */ -}}
   {{- $locale := or $site.Params.seo.locale $site.Language.LanguageCode -}}
   {{- $twitterSite := $site.Params.seo.twitterSite -}}
   
   <title>{{ $title }}</title>
   
   <meta name="description" content="{{ $desc }}">
   <link rel="canonical" href="{{ $canonical }}">
   
   {{- if $noindex }}<meta name="robots" content="noindex,follow">{{ end -}}
   
   <!-- Open Graph -->
   <meta property="og:site_name" content="{{ $site.Title }}">
   <meta property="og:title" content="{{ $title }}">
   <meta property="og:description" content="{{ $desc }}">
   <meta property="og:type" content="{{ $type }}">
   <meta property="og:url" content="{{ $canonical }}">
   {{- with $locale }}<meta property="og:locale" content="{{ . }}">{{ end }}
   {{- range $absImgs }}<meta property="og:image" content="{{ . }}">{{ end }}
   {{- with $published }}<meta property="article:published_time" content="{{ . }}">{{ end }}
   {{- with $modified  }}<meta property="article:modified_time"  content="{{ . }}">{{ end }}
   
   <!-- Twitter -->
   <meta name="twitter:card" content="{{ $twitterCard }}">
   {{- with $twitterSite }}<meta name="twitter:site" content="{{ . }}">{{ end }}
   <meta name="twitter:title" content="{{ $title }}">
   <meta name="twitter:description" content="{{ $desc }}">
   {{- with $firstImg }}<meta name="twitter:image" content="{{ . }}">{{ end }}
   
   {{- /* JSON-LD: Movie if we have film_title */ -}}
   {{- if $p.Params.film_title -}}
     {{- $mins := $p.Params.minutes | default 0 -}}
     {{- $duration := printf "PT%dM" $mins -}}
     {{- $dir := or $p.Params.Director $p.Params.director -}}
     {{- $actorsCSV := $p.Params.Actors | default "" -}}
     {{- $actors := slice -}}
     {{- if $actorsCSV -}}
       {{- range (split $actorsCSV ",") -}}
         {{- $actors = $actors | append (dict "@type" "Person" "name" (trim . " ")) -}}
       {{- end -}}
     {{- end -}}
     {{- $json := dict
         "@context" "https://schema.org"
         "@type"   "Movie"
         "name"    $p.Params.film_title
         "datePublished" ($published | time.Format "2006-01-02")
         "duration" $duration
         "description" $desc
         "image"  $absImgs
       -}}
     {{- if $dir }}{{ $json = merge $json (dict "director" (dict "@type" "Person" "name" $dir)) }}{{ end -}}
     {{- if gt (len $actors) 0 }}{{ $json = merge $json (dict "actor" $actors) }}{{ end -}}
     {{- with $p.Params.Genre }}{{ $json = merge $json (dict "genre" .) }}{{ end -}}
     {{- with $p.Params.country }}{{ $json = merge $json (dict "countryOfOrigin" .) }}{{ end -}}
   
     <script type="application/ld+json">{{ $json | jsonify }}</script>
   {{- end -}}
   