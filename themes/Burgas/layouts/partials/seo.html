{{- $p := . -}}
{{- $site := site -}}

{{/* ---------- Config shortcuts ---------- */}}
{{- $seo := $site.Params.seo | default (dict) -}}
{{- $siteName := or $seo.site_name $site.Title -}}
{{- $defaultImage := or $seo.defaultImage "/img/og-default.jpg" -}}
{{- $ogLocale := or $seo.locale "bg_BG" -}}
{{- $twitterCard := or $seo.twitterCard "summary_large_image" -}}
{{- $twitterSite := $seo.twitterSite -}}
{{- $robots := $seo.robots -}}

{{/* Per-page overrides allowed under .Params.seo.* (optional) */}}
{{- $pageSEO := $p.Params.seo | default (dict) -}}
{{- $ogTypeOverride := $pageSEO.type -}}      {{/* e.g. "article" | "website" */}}
{{- $twitterCard = or $pageSEO.twitterCard $twitterCard -}}
{{- $twitterSite = or $pageSEO.twitterSite $twitterSite -}}

{{/* ---------- Title ---------- */}}
{{- $title := cond $p.IsHome $site.Title (printf "%s | %s" (or $p.Title $p.File.BaseFileName) $site.Title) -}}
{{- with $p.Params.film_title -}}
  {{- $yearPart := "" -}}
  {{- with $p.Params.year }}{{ $yearPart = printf " (%v)" . }}{{ end -}}
  {{- $title = printf "%s%s | %s" . $yearPart $site.Title -}}
{{- end -}}

{{- if and (eq $p.Section "blog") $p.IsPage -}}
  {{- $title = or $p.Params.name $p.Title $p.File.BaseFileName -}}
{{- end -}}


{{/* ---------- Description ---------- */}}
{{- $desc := or $p.Params.description $p.Summary $site.Params.description -}}
{{- $desc = $desc | plainify | truncate 160 -}}

{{/* ---------- Images (absolute): feature_image -> thumbnail -> site default ---------- */}}
{{- $imgs := slice -}}
{{- with $p.Params.feature_image }}{{ $imgs = $imgs | append . }}{{ end -}}
{{- if and (eq (len $imgs) 0) $p.Params.thumbnail }}{{ $imgs = $imgs | append $p.Params.thumbnail }}{{ end -}}
{{- if and (eq (len $imgs) 0) $defaultImage }}{{ $imgs = $imgs | append $defaultImage }}{{ end -}}
{{- $absImgs := slice -}}
{{- range $imgs }}{{ $absImgs = $absImgs | append (absURL .) }}{{ end -}}
{{- $firstImg := cond (gt (len $absImgs) 0) (index $absImgs 0) "" -}}

{{/* ---------- Dates ---------- */}}
{{- $published := $p.Date | time -}}
{{- $modified  := $p.Lastmod | default $p.Date | time -}}

{{/* ---------- Canonical ---------- */}}
<link rel="canonical" href="{{ $p.Permalink }}"/>

{{/* ---------- Basic meta ---------- */}}
<title>{{ $title }}</title>
<meta name="description" content="{{ $desc }}"/>
{{- with $robots }}<meta name="robots" content="{{ . }}"/>{{ end }}

{{/* ---------- Open Graph ---------- */}}
<meta property="og:type" content="{{ or $ogTypeOverride (cond $p.IsHome "website" "article") }}">
<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $desc }}">
<meta property="og:url" content="{{ $p.Permalink }}">
<meta property="og:site_name" content="{{ $siteName }}">
<meta property="og:locale" content="{{ $ogLocale }}">
{{- with $firstImg }}<meta property="og:image" content="{{ . }}">{{ end }}
<meta property="article:published_time" content="{{ $published.Format "2006-01-02T15:04:05Z07:00" }}">
<meta property="article:modified_time"  content="{{ $modified.Format  "2006-01-02T15:04:05Z07:00" }}">

{{/* ---------- Twitter ---------- */}}
<meta name="twitter:card" content="{{ $twitterCard }}">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $desc }}">
{{- with $firstImg }}<meta name="twitter:image" content="{{ . }}">{{ end }}
{{- with $twitterSite }}<meta name="twitter:site" content="{{ . }}">{{ end }}

{{/* ---------- JSON-LD: WebSite (Home only) ---------- */}}
{{- if $p.IsHome -}}
  <script type="application/ld+json">
  {{ dict
      "@context" "https://schema.org"
      "@type" "WebSite"
      "name" $siteName
      "url" $site.BaseURL
    | jsonify | safeJS }}
  </script>
{{- end -}}

{{/* ---------- JSON-LD: Movie (ONLY on single film pages) ---------- */}}
{{- if and (eq $p.Section "films") $p.IsPage -}}
  {{- $movieName := or $p.Params.film_title $p.Title -}}
  {{- $movie := dict "@context" "https://schema.org" "@type" "Movie" "name" $movieName -}}
  {{- with $firstImg          }}{{ $movie = merge $movie (dict "image" .) }}{{ end -}}
  {{- with $desc              }}{{ $movie = merge $movie (dict "description" .) }}{{ end -}}
  {{- with $published         }}{{ $movie = merge $movie (dict "datePublished" ($published.Format "2006-01-02T15:04:05Z07:00")) }}{{ end -}}
  {{- with $p.Params.minutes  }}{{ $movie = merge $movie (dict "duration" (printf "PT%vM" .)) }}{{ end -}}
  {{- with $p.Params.country  }}{{ $movie = merge $movie (dict "countryOfOrigin" (slice (dict "@type" "Country" "name" .))) }}{{ end -}}

  {{/* Directors (comma-separated string to Person[]) -- support both director/Director */}}
  {{- $directors := slice -}}
  {{- $dirStr := or $p.Params.director $p.Params.Director -}}
  {{- with $dirStr -}}
    {{- range (split . ",") -}}
      {{- $directors = $directors | append (dict "@type" "Person" "name" (trim . " ")) -}}
    {{- end -}}
  {{- end -}}
  {{- if gt (len $directors) 0 }}{{ $movie = merge $movie (dict "director" $directors) }}{{ end -}}

  {{/* Actors: prefer lead_actors/LeadActors then actors/Actors (comma-separated) */}}
  {{- $actorsArr := slice -}}
  {{- $actorsStr := or $p.Params.lead_actors $p.Params.LeadActors $p.Params.actors $p.Params.Actors -}}
  {{- with $actorsStr -}}
    {{- range (split . ",") -}}
      {{- $actorsArr = $actorsArr | append (dict "@type" "Person" "name" (trim . " ")) -}}
    {{- end -}}
  {{- end -}}
  {{- if gt (len $actorsArr) 0 }}{{ $movie = merge $movie (dict "actor" $actorsArr) }}{{ end -}}

  <script type="application/ld+json">
  {{ $movie | jsonify | safeJS }}
  </script>
{{- end -}}

{{/* ---------- JSON-LD: ItemList for film archive (films section list page) ---------- */}}
{{- if and (eq $p.Section "films") $p.IsSection -}}
  {{- $items := slice -}}
  {{- range $p.Pages.ByDate.Reverse -}}
    {{- $items = $items | append (dict
      "@type" "ListItem"
      "position" (add 1 (len $items))
      "url" (absURL .RelPermalink)
      "name" (or .Params.film_title .Title)
    ) -}}
  {{- end -}}
  <script type="application/ld+json">
  {{ dict "@context" "https://schema.org" "@type" "ItemList" "itemListElement" $items | jsonify | safeJS }}
  </script>
{{- end -}}

{{/* ---------- JSON-LD: CollectionPage for posters (posters section list page) ---------- */}}
{{- if and (eq $p.Section "posters") $p.IsSection -}}
  {{- $parts := slice -}}
  {{- range $p.Pages.ByDate.Reverse -}}
    {{- $img := or .Params.thumbnail (index (.Params.images | default (slice "")) 0) -}}
    {{- if $img -}}
      {{- $parts = $parts | append (dict
          "@type" "ImageObject"
          "name"  (or .Params.title .Title)
          "contentUrl" (absURL $img)
          "url" (absURL .Permalink)
        ) -}}
    {{- end -}}
  {{- end -}}
  <script type="application/ld+json">
  {{ dict
      "@context" "https://schema.org"
      "@type" "CollectionPage"
      "name" (or $p.Title "Плакати")
      "hasPart" $parts
    | jsonify | safeJS }}
  </script>
{{- end -}}
