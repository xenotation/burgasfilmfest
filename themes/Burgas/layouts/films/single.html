{{ define "main" }}

{{ $main := resources.Get "css/film-single.css" | minify | fingerprint }}
<link rel="stylesheet" href="{{ $main.RelPermalink }}" integrity="{{ $main.Data.Integrity }}" crossorigin="anonymous">

<!-- Video.js (CSS + JS) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@8/dist/video-js.min.css">
<script src="https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js" defer></script>
<!-- Explicit VHS (HLS) engine for Video.js -->
<script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3/dist/videojs-http-streaming.min.js" defer></script>

<article class="film-single">
  <div class="film-inner">
    <!-- top section -->
    <div class="film-top">
      <div class="film-poster">
        <img src="{{ .Params.thumbnail }}" alt="{{ .Params.film_title }}">
      </div>

      <div class="film-meta-single">
        <h1 class="film-title-single">
          {{ .Params.film_title }}
          {{ with .Params.film_title_org }}
          <p class="film-title-org" style="display:block; font-size:1.2rem; margin-top:0.2rem;">
            {{ . }}
          </p>
          {{ end }}
        </h1>

        <p class="film-details">{{ .Params.year }} · {{ .Params.country }} · {{ .Params.minutes }} мин.</p>
        <p class="film-description">{{ .Params.description }}</p>

        <div class="film-credits-grid">
          {{ with .Params.Director }}
            <div class="credit"><span class="credit-label">Режисьор</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ with .Params.Production }}
            <div class="credit"><span class="credit-label">Продуцент</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ with .Params.Screenwriter }}
            <div class="credit"><span class="credit-label">Сценарий</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ with .Params.Editing }}
            <div class="credit"><span class="credit-label">Монтаж</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ $dop := .Params.Cinematography | default .Params.Operator }}
          {{ with $dop }}
            <div class="credit"><span class="credit-label">Оператор</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ with .Params.Sound }}
            <div class="credit"><span class="credit-label">Звук</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ with .Params.Music }}
            <div class="credit"><span class="credit-label">Музика</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ with .Params.Voiceover }}
            <div class="credit"><span class="credit-label">Глас зад кадър</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
          {{ $actors := .Params.LeadActors | default .Params.Actors }}
          {{ with $actors }}
            <div class="credit"><span class="credit-label">Главни актьори</span><span class="credit-value">{{ . }}</span></div>
          {{ end }}
        </div>

        {{ if .Params.show_watch_button }}
          <!-- HARD-CODED HLS + TOKEN (for debugging) -->
          {{ $HARD_HLS := "https://customer-tkp9gv7016aue3fr.cloudflarestream.com/6799329e49d585252f581311c19642d3/manifest/video.m3u8?token=eyJhbGciOiJSUzI1NiIsImtpZCI6IjMxMzAxMDQ4ZmE2NjkwNTllZmY1ZjFiNGFiNmQxOGMwIn0.eyJzdWIiOiI2Nzk5MzI5ZTQ5ZDU4NTI1MmY1ODEzMTFjMTk2NDJkMyIsImtpZCI6IjMxMzAxMDQ4ZmE2NjkwNTllZmY1ZjFiNGFiNmQxOGMwIiwiZXhwIjoiMTc1Nzc1NjE0MSIsIm5iZiI6IjE3NTc2NjYxNDEiLCJhY2Nlc3NSdWxlcyI6W3siYWN0aW9uIjoiYWxsb3ciLCJ0eXBlIjoiaXAuZ2VvaXAuY291bnRyeSIsImNvdW50cnkiOlsiQkciXX0seyJhY3Rpb24iOiJibG9jayIsInR5cGUiOiJhbnkifV19.nal-Y3RkUVE_Pi9A3mHFNC1zLYpVPNdWVj0TD5QXJX72T-5boIAXK85SvhrUHKRMhM8YWwx2gsVUpSie3zMia4HTn79G4lWkmCxco-HGTrUKxZcrHSNvzC7i2nfQhgEmmnTlcHjLdUramLCp680Ahe3ASeWHIEgln9019ckBIFkLyg0j5JYILeh-IIl1UZfZixGS2NcQAZo1vFIWXWx8LYRsk0Su3_BxOOKZFAtHHttW0hvn3FjyHf4JLlbcvIi1glHEs9pzznUyHwZMxDRpn3Tu25NhTRMVtnbDRFKtZftqm182GfYnagg29mwXpPrnBsMgnOuD-hta0CwaFlnB6A" }}

          <div class="watch-button-wrapper">
            <a class="watch-button"
               href="#watch-modal"
               data-dimbox
               data-dimbox-type="inline"
               data-dimbox-class="dimbox-full"
               data-dimbox-target="#watch-modal">
              гледай
            </a>
          </div>

          <!-- Inline modal with Video.js player -->
          <div id="watch-modal" style="display:none; max-width:min(90vw, 1200px);">
            <div style="margin: 0 0 .5rem 0; font-size:.875rem; opacity:.8;">
              Debug: <a href="{{ $HARD_HLS }}" target="_blank" rel="noopener">open manifest in a new tab</a>
            </div>

            <video
              id="film-player"
              class="video-js vjs-default-skin vjs-big-play-centered"
              controls
              preload="auto"
              playsinline
              crossorigin="anonymous"
              style="width:100%; height:auto;"
              poster="{{ .Params.feature_image }}"
              data-setup='{}'>
              <!-- Deliberately NO type attribute; let VHS handle HLS -->
              <source src="{{ $HARD_HLS }}">
            </video>
          </div>

          <script>
            document.addEventListener('DOMContentLoaded', function () {
              if (!window.videojs) return;

              var HLS_URL = {{ $HARD_HLS | jsonify }};

              // Quick fetch check so we know if token/geo is the blocker (shows status in console)
              fetch(HLS_URL, { method: 'GET', mode: 'cors' })
                .then(function(res) {
                  console.log('[HLS manifest fetch]', res.status, res.statusText);
                  if (!res.ok) {
                    console.warn('Manifest fetch not OK. If 403, token/geo/access rule is blocking.');
                  }
                  return res.text();
                })
                .then(function(text) {
                  console.log('[HLS manifest first 200 chars]', text.slice(0, 200));
                })
                .catch(function(err) {
                  console.error('Manifest fetch error:', err);
                });

              var player = window.videojs('film-player', {
                fluid: true,
                preload: 'auto',
                controls: true,
                inactivityTimeout: 3000,
                playbackRates: [0.75, 1, 1.25, 1.5, 2],
                html5: {
                  vhs: {
                    overrideNative: true,
                    enableLowInitialPlaylist: true
                  }
                },
                techOrder: ['html5']
              });

              player.on('loadedmetadata', function () {
                try {
                  var tracks = player.textTracks();
                  for (var i = 0; i < tracks.length; i++) {
                    if (tracks[i].kind === 'subtitles' || tracks[i].kind === 'captions') {
                      tracks[i].mode = 'showing';
                      break;
                    }
                  }
                } catch (e) {}
              });

              player.on('error', function () {
                var err = player.error();
                console.error('VIDEOJS error:', err);
              });

              // Pause on modal close (dimbox custom event hook)
              document.addEventListener('dimbox:close', function () {
                try { player.pause(); } catch (_) {}
              });
            });
          </script>
        {{ end }}
      </div>
    </div>

    <!-- markdown body -->
    {{ $hasBody := ne (trim (plainify .Content) " \n\r\t") "" }}
    {{ if $hasBody }}
      <div class="film-body">
        {{ .Content }}
      </div>
    {{ end }}

  </div>
</article>

<!-- Minimal fixes / styling -->
<style>
.film-title-single {
  font-size: clamp(1.6rem, 2vw + 1rem, 2.4rem);
  margin: 0 0 .5rem 0;
}
/* Video.js – subtitles / captions */
.vjs-text-track-display { text-shadow: none; }
.vjs-text-track-cue {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif;
  font-size: 1rem;
  line-height: 1.35;
  background: rgba(0,0,0,0.55);
  padding: .25rem .5rem;
  border-radius: .25rem;
}
.vjs-caption-settings { font-size: 14px; }
</style>

{{ end }}
