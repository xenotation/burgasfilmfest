{{ define "main" }}

{{ $main := resources.Get "css/film-single.css" | minify | fingerprint }}
<link rel="stylesheet" href="{{ $main.RelPermalink }}" integrity="{{ $main.Data.Integrity }}" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@8/dist/video-js.min.css">
<script src="https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3/dist/videojs-http-streaming.min.js" defer></script>

<article class="film-single">
  <div class="film-inner">
    <div class="film-top">
      <div class="film-poster">
        <img src="{{ .Params.thumbnail }}" alt="{{ .Params.film_title }}">
      </div>

      <div class="film-meta-single">
        <h1 class="film-title-single">
          {{ .Params.film_title }}
          {{ with .Params.film_title_org }}
            <p class="film-title-org" style="display:block; font-size:1.2rem; margin-top:.2rem;">{{ . }}</p>
          {{ end }}
        </h1>

        <p class="film-details">{{ .Params.year }} · {{ .Params.country }} · {{ .Params.minutes }} мин.</p>
        <p class="film-description">{{ .Params.description }}</p>

        <div class="film-credits-grid">
          {{ with .Params.Director }}<div class="credit"><span class="credit-label">Режисьор</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ with .Params.Production }}<div class="credit"><span class="credit-label">Продуцент</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ with .Params.Screenwriter }}<div class="credit"><span class="credit-label">Сценарий</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ with .Params.Editing }}<div class="credit"><span class="credit-label">Монтаж</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ $dop := .Params.Cinematography | default .Params.Operator }}
          {{ with $dop }}<div class="credit"><span class="credit-label">Оператор</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ with .Params.Sound }}<div class="credit"><span class="credit-label">Звук</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ with .Params.Music }}<div class="credit"><span class="credit-label">Музика</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ with .Params.Voiceover }}<div class="credit"><span class="credit-label">Глас зад кадър</span><span class="credit-value">{{ . }}</span></div>{{ end }}
          {{ $actors := .Params.LeadActors | default .Params.Actors }}
          {{ with $actors }}<div class="credit"><span class="credit-label">Главни актьори</span><span class="credit-value">{{ . }}</span></div>{{ end }}
        </div>

        {{ if .Params.show_watch_button }}
          {{/* HLS URL logic (prefer .Params.HLS; else build; replace id with token if present) */}}
          {{ $videoID := .Params.video_id }}
          {{ $customer := "customer-ojfdlxwm7xyjwjmt.cloudflarestream.com" }}
          {{ $hls := .Params.HLS | default (printf "https://%s/%s/manifest/video.m3u8" $customer $videoID) }}
          {{ $token := .Params.signed_token | default "" }}
          {{ $token = replaceRE "\\s+" "" $token }}
          {{ if and $token $videoID (in $hls $videoID) }}{{ $hls = replace $hls $videoID $token }}{{ end }}

          <div class="watch-button-wrapper">
            <a class="watch-button" href="#" id="watch-btn">гледай</a>
          </div>

          <!-- Lightbox (moved to <body> on load to avoid clipping) -->
          <div id="vjs-lightbox" aria-hidden="true">
            <button class="vjs-close" type="button" aria-label="Затвори">✕</button>
            <div class="vjs-modal">
              <video id="film-player"
                     class="video-js vjs-default-skin vjs-big-play-centered"
                     controls preload="auto" playsinline
                     crossorigin="anonymous"
                     poster="{{ .Params.feature_image }}"
                     data-setup="{}">
                <source src="{{ $hls }}" type="application/x-mpegURL" />
                {{ with .Params.subtitles }}
                  {{ range . }}
                    {{- $isBG := eq (lower .srclang) "bg" -}}
                    <track kind="subtitles"
                           src="{{ .src | relURL }}"
                           srclang="{{ .srclang }}"
                           label="{{ .label }}"
                           {{ if or .default $isBG }}default{{ end }}>
                  {{ end }}
                {{ end }}
              </video>
            </div>
          </div>
        {{ end }}
      </div>
    </div>

    {{ $hasBody := ne (trim (plainify .Content) " \n\r\t") "" }}
    {{ if $hasBody }}<div class="film-body">{{ .Content }}</div>{{ end }}
  </div>
</article>

<style>
/* Full-viewport lightbox */
#vjs-lightbox{
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  display: none;
  align-items: center; justify-content: center;
  background: rgba(0,0,0,.88);
  z-index: 2147483000;
  padding: 16px;
}
#vjs-lightbox.show{ display: flex; }

#vjs-lightbox .vjs-modal{
  width: min(96vw, 1100px);
  max-height: calc(100vh - 32px);
}
#vjs-lightbox video{
  width: 100%;
  height: auto;
  max-height: 100%;
  background: #000;
}

/* Close button */
.vjs-close{
  position: fixed;
  top: 14px; right: 14px;
  background: rgba(0,0,0,.55);
  color: #fff;
  border: 1px solid rgba(255,255,255,.35);
  border-radius: 10px;
  padding: .45rem .65rem;
  cursor: pointer;
  z-index: 2147483001;
}

/* Subtitles: transparent bg */
.video-js::cue{
  background: transparent !important;
  color: #fff;
  font-size: 1.05rem;
  line-height: 1.35;
  text-shadow: 0 2px 4px rgba(0,0,0,.9);
}
.video-js .vjs-text-track-display .vjs-text-track-cue div{
  background: transparent !important;
  padding: .15em .35em;
  border-radius: .2em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var btn  = document.getElementById('watch-btn');
  var box  = document.getElementById('vjs-lightbox');
  if (!btn || !box) return;

  // Ensure overlay is at body level
  if (box.parentNode !== document.body) document.body.appendChild(box);

  var player, inited = false;

  function pickBulgarianSubs(p){
    try {
      var tracks = p.textTracks();
      var picked = false;
      for (var i = 0; i < tracks.length; i++) {
        var t = tracks[i];
        var isSub = (t.kind === 'subtitles' || t.kind === 'captions');
        var isBG  = (t.language && t.language.toLowerCase() === 'bg') ||
                    (t.label && t.label.toLowerCase().includes('бъл')); // "български"
        if (isSub) {
          t.mode = 'disabled';
          if (!picked && isBG) { t.mode = 'showing'; picked = true; }
        }
      }
    } catch(e){}
  }

  function openBox(e){
    if (e) e.preventDefault();
    box.classList.add('show');
    box.setAttribute('aria-hidden','false');

    function init(){
      if (inited) { try { player.play(); } catch(_){ } pickBulgarianSubs(player); return; }
      player = window.videojs('film-player', {
        fluid: true,
        controls: true,
        preload: 'auto',
        html5: {
          vhs: {
            overrideNative: true,           // keep VHS
            enableLowInitialPlaylist: false,// don't start on lowest
            defaultBandwidthEstimate: 12000000, // ~12 Mbps initial guess
            bandwidth: 12000000,                // same nudge
            limitRenditionByPlayerDimensions: false, // allow 1080p even in small player
            useDevicePixelRatio: true
          }
        },
        controlBar: { pictureInPictureToggle: true, volumePanel: { inline: false } }
      });
      
      inited = true;
      player.ready(function(){
        pickBulgarianSubs(player);
        try { player.play(); } catch(_){}
      });
      player.on('loadedmetadata', function(){ pickBulgarianSubs(player); });
      player.on('loadeddata',    function(){ pickBulgarianSubs(player); });
      setTimeout(function(){ pickBulgarianSubs(player); }, 400);
    }
    init();
  }

  function closeBox(){
    box.classList.remove('show');
    box.setAttribute('aria-hidden','true');
    if (player) { try { player.pause(); } catch(_){} }
  }

  btn.addEventListener('click', openBox);
  box.addEventListener('click', function(e){ if (e.target === box) closeBox(); });
  var x = box.querySelector('.vjs-close'); if (x) x.addEventListener('click', closeBox);
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && box.classList.contains('show')) closeBox(); });
});
</script>

<style>
.film-title-single{font-size:clamp(1.6rem,2vw+1rem,2.4rem);margin:0 0 .5rem 0;}
</style>

{{ end }}
