{{ define "main" }}

{{ $main := resources.Get "css/film-single.css" | minify | fingerprint }}
<link rel="stylesheet" href="{{ $main.RelPermalink }}" integrity="{{ $main.Data.Integrity }}" crossorigin="anonymous">

<article class="film-single">
  <div class="film-inner">
    <div class="film-top">
      <div class="film-poster">
        <img src="{{ .Params.thumbnail }}" alt="{{ .Params.film_title }}">
      </div>

      <div class="film-meta-single">
        <h1 class="film-title-single">
          {{ .Params.film_title }} <span class="year">({{ .Params.year }})</span>
        </h1>
        <p class="film-details">{{ .Params.country }} · {{ .Params.minutes }} min</p>
        <p class="film-description">{{ .Params.description }}</p>

        <div class="film-credits-grid">
          <div class="credit"><span class="credit-label">режисьор</span><span class="credit-value">{{ .Params.Director }}</span></div>
          <div class="credit"><span class="credit-label">продуцент</span><span class="credit-value">{{ .Params.Producers }}</span></div>
          <div class="credit"><span class="credit-label">актьори</span><span class="credit-value">{{ .Params.Actors }}</span></div>
          <div class="credit"><span class="credit-label">сценарист</span><span class="credit-value">{{ .Params.Screenwriter }}</span></div>
        </div>

        {{ if .Params.show_watch_button }}
          {{/* If you have a signed token, use it; else fall back to the video_id */}}
          {{ $src := .Params.video_id }}
          {{ with .Params.signed_token }}{{ $src = . }}{{ end }}

          <div class="watch-button-wrapper">
            <button class="watch-button" type="button" id="open-player">гледай</button>
          </div>

          <div id="player-wrap" class="player-wrap" hidden>
            <div class="player-ratio">
              <iframe
                id="stream-player"
                src="https://customer-{{ .Site.Params.cf_stream_customer_code }}.cloudflarestream.com/{{ $src }}/iframe?preload=true&autoplay=true"
                style="border:none;position:absolute;inset:0;width:100%;height:100%"
                allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
                allowfullscreen="true">
              </iframe>
            </div>
            <div id="player-fallback" class="player-fallback" hidden>
              Видеото не е достъпно в момента.
            </div>
          </div>
          <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>
          <script>
            (function () {
              const btn = document.getElementById('open-player');
              const wrap = document.getElementById('player-wrap');
              const iframe = document.getElementById('stream-player');
              const fallback = document.getElementById('player-fallback');
              btn?.addEventListener('click', () => { wrap.hidden = false; });

              // Listen for player errors (e.g., invalid/expired token -> 401 inside player)
              const player = Stream(iframe);
              player.addEventListener('error', () => {
                // Hide the iframe player and show your centered message
                iframe.style.display = 'none';
                fallback.hidden = false;
                // Optional: announce to screen readers
                fallback.setAttribute('role', 'alert');
              });
            })();
          </script>
        {{ end }}

      </div>
    </div>

    <div class="film-body">
      {{ .Content }}
    </div>
  </div>
</article>

{{ end }}
